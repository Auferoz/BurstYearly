---
interface Props {
    movies: any[];
}

const { movies = [] } = Astro.props;

// Filtrar películas que tengan fanart
const moviesWithFanart = movies.filter(item => item?.movie?.images?.fanart?.[0]);
---

<section class="carousel-container relative w-full overflow-hidden rounded-lg mb-6">
    <div class="carousel-track flex transition-transform duration-500 ease-out">
        {moviesWithFanart.map((item, index) => (
            <div
                class="carousel-slide min-w-full relative"
                data-index={index}
            >
                <img
                    class="w-full h-[200px] sm:h-[280px] md:h-[350px] lg:h-[420px] object-cover"
                    src={`https://${item.movie.images.fanart[0]}`}
                    alt={`Fanart de ${item.movie.title}`}
                    loading={index === 0 ? "eager" : "lazy"}
                />
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>
                <div class="absolute bottom-4 left-4 right-4">
                    <h3 class="text-white text-lg sm:text-xl font-semibold truncate">{item.movie.title}</h3>
                    <p class="text-zinc-300 text-sm">{item.movie.year}</p>
                </div>
            </div>
        ))}
    </div>

    <!-- Indicadores -->
    <div class="absolute bottom-4 right-4 flex gap-1.5">
        {moviesWithFanart.slice(0, 10).map((_, index) => (
            <button
                class="carousel-dot w-2 h-2 rounded-full bg-white/40 transition-all duration-300 hover:bg-white/70"
                data-index={index}
                aria-label={`Ir a imagen ${index + 1}`}
            ></button>
        ))}
    </div>

    <!-- Controles -->
    <button class="cursor-pointer carousel-prev absolute left-2 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-black/30 backdrop-blur-sm text-white flex items-center justify-center opacity-0 transition-opacity duration-300 hover:bg-black/50">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
        </svg>
    </button>
    <button class="cursor-pointer carousel-next absolute right-2 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-black/30 backdrop-blur-sm text-white flex items-center justify-center opacity-0 transition-opacity duration-300 hover:bg-black/50">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
        </svg>
    </button>
</section>

<style>
    .carousel-container:hover .carousel-prev,
    .carousel-container:hover .carousel-next {
        opacity: 1;
    }

    .carousel-dot.active {
        background-color: white;
        width: 1.5rem;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const container = document.querySelector('.carousel-container');
        if (!container) return;

        const track = container.querySelector('.carousel-track') as HTMLElement;
        const dots = container.querySelectorAll('.carousel-dot');
        const prevBtn = container.querySelector('.carousel-prev');
        const nextBtn = container.querySelector('.carousel-next');
        const slides = container.querySelectorAll('.carousel-slide');

        let currentIndex = 0;
        const maxIndex = Math.min(slides.length - 1, 9); // Máximo 10 slides
        let autoplayInterval: ReturnType<typeof setInterval>;

        function goToSlide(index: number) {
            if (index < 0) index = maxIndex;
            if (index > maxIndex) index = 0;
            currentIndex = index;

            track.style.transform = `translateX(-${currentIndex * 100}%)`;

            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === currentIndex);
            });
        }

        function startAutoplay() {
            autoplayInterval = setInterval(() => {
                goToSlide(currentIndex + 1);
            }, 5000);
        }

        function stopAutoplay() {
            clearInterval(autoplayInterval);
        }

        // Event listeners
        prevBtn?.addEventListener('click', () => {
            goToSlide(currentIndex - 1);
            stopAutoplay();
            startAutoplay();
        });

        nextBtn?.addEventListener('click', () => {
            goToSlide(currentIndex + 1);
            stopAutoplay();
            startAutoplay();
        });

        dots.forEach((dot, index) => {
            dot.addEventListener('click', () => {
                goToSlide(index);
                stopAutoplay();
                startAutoplay();
            });
        });

        // Inicializar
        goToSlide(0);
        startAutoplay();

        // Pausar en hover
        container.addEventListener('mouseenter', stopAutoplay);
        container.addEventListener('mouseleave', startAutoplay);
    });
</script>
