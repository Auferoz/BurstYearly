---
import CheckupList from "../icons/CheckupList.astro";
import DeviceTvOld from "../icons/DeviceTvOld.astro";
import DisneyPlus from "../icons/DisneyPlus.astro";
import Crunchyroll from "../icons/Crunchyroll.astro";
import HboMax from "../icons/HboMax.astro";
import Netflix from "../icons/Netflix.astro";

const { series = [] } = Astro.props;
---

{
    series.map((item) => (
        <div class="relative mt-4 hidden lg:flex">
            <!-- Badge fuera del overflow -->
            <div class="absolute -top-3 left-1/2 -translate-x-1/2 z-10 border-1 border-gray-700 bg-zinc-900 rounded-lg">
                <span class="FiraCodeFont text-xs text-white flex flex-row justify-center items-center gap-1 p-1">
                    <CheckupList width="16" height="16" /> {item.rank}
                </span>
            </div>

            <article class={`flex flex-col justify-between relative rounded-xl border-2 border-gray-700 group overflow-hidden ${item.statusViewed === 'ongoing' ? 'ongoing' : 'completed'}`} data-show-id={item.show?.ids?.trakt || ''}>
                
                <!-- Bot贸n Info para abrir modal -->
                <button 
                    class="btn-series-info absolute bottom-8 left-2 z-10 p-1.5 bg-zinc-900/90 border border-gray-600 rounded-lg opacity-0 group-hover:opacity-100 hover:bg-sky-700 hover:border-sky-600 transition-all duration-200"
                    data-series={JSON.stringify({
                        title: `${item.show?.title || ''} - Season ${item.numberSeason || ''}`,
                        poster: `https://${item.show?.images?.poster?.[0] || item.show?.images?.poster?.[0] || ''}`,
                        logo: item.season?.images?.logo?.[0] ? `https://${item.season.images.logo[0]}` : (item.show?.images?.logo?.[0] ? `https://${item.show.images.logo[0]}` : null),
                        banner: item.season?.images?.banner?.[0] ? `https://${item.season.images.banner[0]}` : (item.show?.images?.banner?.[0] ? `https://${item.show.images.banner[0]}` : null),
                        fanart: item.season?.images?.fanart?.[0] ? `https://${item.season.images.fanart[0]}` : (item.show?.images?.fanart?.[0] ? `https://${item.show.images.fanart[0]}` : null),
                        clearart: item.season?.images?.clearart?.[0] ? `https://${item.season.images.clearart[0]}` : (item.show?.images?.clearart?.[0] ? `https://${item.show.images.clearart[0]}` : null),
                        thumb: item.season?.images?.thumb?.[0] ? `https://${item.season.images.thumb[0]}` : (item.show?.images?.thumb?.[0] ? `https://${item.show.images.thumb[0]}` : null),
                        releaseDate: item.season?.first_aired || item.show?.first_aired || null,
                        rating: item.show?.rating ? Math.round(item.show.rating * 10) / 10 : null,
                        runtime: item.show?.runtime ? `${item.show.runtime} min/ep` : null,
                        totalRuntime: item.show?.runtime && item.season?.episode_count ? item.show.runtime * item.season.episode_count : null,
                        genres: item.show?.genres,
                        overview: item.season?.overview || item.show?.overview,
                        trailer: item.show?.trailer,
                        platform: item.platformViewed,
                        episodes: item.season?.episode_count,
                        actors: item.show?.actors || [],
                        director: item.show?.director || null,
                        country: item.show?.country || null
                    })}
                    aria-label={`Ver informaci贸n de ${item.show?.title || ''}`}
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>

                <img
                    src={`https://${item.season?.images?.poster?.[0] || item.show?.images?.poster?.[0] || ''}`}
                    alt={item.show?.title || ''}
                    class="w-full h-full rounded-lg min-h-[296px]"
                />

                <div class="absolute items-center justify-center h-7 w-full bottom-0 left-0 z-10 bg-zinc-900/80 border-t-1 border-zinc-950 rounded-xs hidden group-hover:flex">
                    <span class="FiraCodeFont text-xs text-white flex flex-row justify-center items-center gap-1 p-1">
                        {item.platformViewed === 'Disney+' && <DisneyPlus width="16" height="16" />}
                        {item.platformViewed === 'Crunchyroll' && <Crunchyroll width="16" height="16" />}
                        {item.platformViewed === 'HBO Max' && <HboMax width="16" height="16" />}
                        {item.platformViewed === 'Netflix' && <Netflix width="16" height="16" />}
                        {item.platformViewed || ''} 
                        <DeviceTvOld width="16" height="16" /> Season {item.numberSeason || ''}
                    </span>
                </div>

                
            </article>
        </div>


        <article class="lg:hidden card-series group relative flex items-stretch overflow-hidden rounded-xl border shadow-lg transition-shadow border-sky-700/50 shadow-sky-700/20 hover:shadow-sky-700/40">
            <!-- Background Image with Mask (usando showBanner) -->
            <div
                class="absolute inset-0 bg-cover bg-center bg-no-repeat opacity-40"
                style={`background-image: url('https://${item.season?.images?.thumb?.[0] || item.show?.images?.thumb?.[0] || ''}'); mask-image: linear-gradient(to left, rgba(0,0,0,1) 0%, rgba(0,0,0,0.3) 60%, rgba(0,0,0,0) 100%); -webkit-mask-image: linear-gradient(to left, rgba(0,0,0,1) 0%, rgba(0,0,0,0.3) 60%, rgba(0,0,0,0) 100%);`}
            ></div>

            <!-- Dark Overlay for better text readability -->
            <div class="absolute inset-0 bg-linear-to-r from-zinc-900/95 via-zinc-900/80 to-transparent"></div>

            <!-- Content Container -->
            <div class="relative z-10 flex w-full gap-3 p-2">
                <!-- Poster Image (usando seasonPoster) -->
                <figure class="shrink-0">
                    <img
                        class="h-28 w-auto rounded-lg object-cover shadow-md"
                        src={`https://${item.season?.images?.poster?.[0] || item.show?.images?.poster?.[0] || ''}`}
                        alt={`Poster de ${item.show?.title || ''}`}
                        loading="lazy"
                        transition:name={`poster-series-${item.idTrakt}-s${item.numberSeason}`}
                    />
                </figure>

                <!-- Info Section -->
                <div class="flex flex-1 flex-col justify-between py-1">
                    <header>
                        <h3 class="text-base font-semibold text-white leading-tight">
                            {item.show?.title || ''}
                            {item.season?.premiere_date && <span class="text-xs text-zinc-400">路 {item.season?.premiere_date}</span>}
                        </h3>
                        <p class="text-xs text-zinc-400 mt-0.5">
                            Season {item.numberSeason || 0} {item.season?.episode_count && `路 ${item.season?.episode_count} Episodes`}
                        </p>
                        {item.show?.genres?.length > 0 && (
                            <p class="text-xs text-zinc-400 mt-0.5 capitalize">
                                {item.show?.genres.slice(0, 2).join(', ')}
                            </p>
                        )}
                    </header>

                    <!-- Footer -->
                    <footer class="flex items-center gap-2 text-xs">
                        <span class="rounded-full bg-zinc-800/80 px-2.5 py-1 text-zinc-300 font-medium capitalize">
                            {item.platformViewed}
                        </span>
                        <span class="text-zinc-500">
                            {item.yearViewed}
                        </span>
                        {item.isWatched && (
                            <span class="ml-auto text-violet-400">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </span>
                        )}
                    </footer>
                </div>

                <!-- Options Modal Button -->
                <button
                    type="button"
                    class="absolute top-2 right-2 p-1 text-zinc-200 hover:text-white transition-colors"
                    aria-label="Opciones"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="12" cy="5" r="2"></circle>
                        <circle cx="12" cy="12" r="2"></circle>
                        <circle cx="12" cy="19" r="2"></circle>
                    </svg>
                </button>
            </div>
        </article>
    ))
}

<script is:inline>
    (function() {
        function initSeriesInfoButtons() {
            document.querySelectorAll('.btn-series-info').forEach(function(btn) {
                // Clone to remove old listeners
                var newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                newBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    var seriesData = JSON.parse(newBtn.getAttribute('data-series') || '{}');
                    if (window.openModalViewed) {
                        window.openModalViewed(seriesData);
                    }
                });
            });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSeriesInfoButtons);
        } else {
            initSeriesInfoButtons();
        }
        document.addEventListener('astro:after-swap', initSeriesInfoButtons);
    })();
</script>