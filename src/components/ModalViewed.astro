---
/**
 * ModalViewed - Modal minimalista para mostrar información de películas/series
 * Se activa mediante JavaScript desde las cards
 */
---

<!-- Modal Container -->
<div id="modal-viewed" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <!-- Overlay -->
    <div id="modal-overlay" class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
    
    <!-- Modal Content -->
    <div id="modal-content" class="relative w-full max-w-5xl max-h-[90vh] overflow-y-auto bg-zinc-900 border border-gray-700 rounded-xl shadow-2xl">
        
        <!-- Header -->
        <div id="modal-header" class="sticky top-0 z-10 flex items-center justify-between p-4 bg-zinc-900/95 backdrop-blur border-b border-gray-700 relative overflow-hidden">
            <!-- Banner Background -->
            <div id="modal-banner-container" class="absolute inset-0 hidden">
                <img 
                    id="modal-banner" 
                    src="" 
                    alt="" 
                    class="absolute right-0 top-1/2 -translate-y-1/2 h-full w-auto object-cover opacity-30"
                />
                <div class="absolute inset-0 bg-gradient-to-r from-zinc-900 via-zinc-900/80 to-transparent"></div>
            </div>
            <!-- Header Content -->
            <h2 id="modal-title" class="text-lg md:text-xl font-bold text-white truncate pr-4 relative z-10">Título</h2>
            <button id="modal-close" class="flex-shrink-0 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 border border-gray-600 hover:border-sky-600 transition-colors relative z-10">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Body -->
        <div class="flex flex-col md:flex-row gap-6 p-4 md:p-6">
            
            <!-- Poster + Logo -->
            <div class="flex-shrink-0 mx-auto md:mx-0 flex flex-col">
                <img 
                    id="modal-poster" 
                    src="" 
                    alt="Poster" 
                    class="w-48 md:w-56 rounded-lg border border-gray-700 shadow-lg"
                />
                <!-- Logo (debajo del poster, centrado) -->
                <div id="modal-logo-container" class="hidden h-full h-20 flex justify-center items-center">
                    <img 
                        id="modal-logo" 
                        src="" 
                        alt="Logo" 
                        class="max-h-20 max-w-full object-contain"
                    />
                </div>
            </div>

            <!-- Info -->
            <div class="flex-1 flex flex-col gap-4">
                
                <!-- Meta Info Row -->
                <div class="flex flex-wrap gap-2">
                    <!-- Fecha (mes y año) -->
                    <span id="modal-date" class="FiraCodeFont inline-flex items-center gap-1.5 px-3 py-1.5 text-xs bg-gray-800 border border-gray-600 rounded-lg text-gray-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <span class="date-value">Jun 2024</span>
                    </span>

                    <!-- Rating -->
                    <span id="modal-rating" class="FiraCodeFont inline-flex items-center gap-1.5 px-3 py-1.5 text-xs bg-sky-900/50 border border-sky-700 rounded-lg text-sky-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        <span class="rating-value">8</span>/10
                    </span>

                    <!-- Runtime -->
                    <span id="modal-runtime" class="FiraCodeFont inline-flex items-center gap-1.5 px-3 py-1.5 text-xs bg-gray-800 border border-gray-600 rounded-lg text-gray-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="runtime-value">120</span> min
                    </span>

                    <!-- Plataforma -->
                    <span id="modal-platform" class="FiraCodeFont inline-flex items-center gap-1.5 px-3 py-1.5 text-xs bg-gray-800 border border-gray-600 rounded-lg text-gray-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        <span class="platform-value">Netflix</span>
                    </span>

                    <!-- Episodes (solo para series) -->
                    <span id="modal-episodes" class="FiraCodeFont inline-flex items-center gap-1.5 px-3 py-1.5 text-xs bg-purple-900/50 border border-purple-700 rounded-lg text-purple-300 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                        </svg>
                        <span class="episodes-value">10</span> episodes
                    </span>

                    <!-- Total Runtime (solo para series) -->
                    <span id="modal-total-runtime" class="FiraCodeFont inline-flex items-center gap-1.5 px-3 py-1.5 text-xs bg-emerald-900/50 border border-emerald-700 rounded-lg text-emerald-300 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="total-runtime-value">7h 30m</span>
                    </span>

                    <!-- Country -->
                    <span id="modal-country" class="FiraCodeFont inline-flex items-center gap-1.5 px-3 py-1.5 text-xs bg-gray-800 border border-gray-600 rounded-lg text-gray-300 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="country-value">US</span>
                    </span>
                </div>

                <!-- Géneros -->
                <div id="modal-genres-container" class="hidden">
                    <h3 class="text-sm font-semibold text-gray-400 mb-2 uppercase tracking-wider">Genres</h3>
                    <div id="modal-genres" class="flex flex-wrap gap-2">
                        <!-- Se llenan dinámicamente -->
                    </div>
                </div>

                <!-- Director -->
                <div id="modal-director-container" class="hidden">
                    <h3 class="text-sm font-semibold text-gray-400 mb-2 uppercase tracking-wider">Director</h3>
                    <span id="modal-director" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm bg-amber-900/30 border border-amber-700/50 rounded-lg text-amber-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        <span class="director-value">Director Name</span>
                    </span>
                </div>

                <!-- Actores -->
                <div id="modal-actors-container" class="hidden">
                    <h3 class="text-sm font-semibold text-gray-400 mb-2 uppercase tracking-wider">Actors</h3>
                    <div id="modal-actors" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2">
                        <!-- Se llenan dinámicamente -->
                    </div>
                </div>

                <!-- Sinopsis -->
                <div class="flex-1">
                    <h3 class="text-sm font-semibold text-gray-400 mb-2 uppercase tracking-wider">Sinopsis</h3>
                    <p id="modal-overview" class="text-sm md:text-base text-gray-300 leading-relaxed">
                        Sin descripción disponible.
                    </p>
                </div>

                <!-- Trailer Button -->
                <div id="modal-trailer-container" class="hidden pt-2">
                    <a 
                        id="modal-trailer-link" 
                        href="#" 
                        target="_blank" 
                        class="inline-flex items-center gap-2 px-4 py-2 bg-sky-700 hover:bg-sky-600 border border-sky-600 rounded-lg text-white text-sm font-medium transition-colors"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Ver Trailer
                    </a>
                </div>

            </div>
        </div>
    </div>
</div>

<style>
    #modal-viewed {
        animation: fadeIn 0.2s ease-out;
    }

    #modal-viewed.hidden {
        display: none;
    }

    #modal-viewed:not(.hidden) {
        display: flex;
    }

    #modal-content {
        animation: slideUp 0.3s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from { 
            opacity: 0;
            transform: translateY(20px) scale(0.98);
        }
        to { 
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* Scrollbar styling */
    #modal-content::-webkit-scrollbar {
        width: 6px;
    }

    #modal-content::-webkit-scrollbar-track {
        background: transparent;
    }

    #modal-content::-webkit-scrollbar-thumb {
        background: #374151;
        border-radius: 3px;
    }

    #modal-content::-webkit-scrollbar-thumb:hover {
        background: #4b5563;
    }
</style>

<script is:inline>
    // Modal functionality - IIFE para evitar conflictos
    (function() {
        function initModal() {
            var modal = document.getElementById('modal-viewed');
            var overlay = document.getElementById('modal-overlay');
            var closeBtn = document.getElementById('modal-close');

            if (!modal || !overlay || !closeBtn) return;

            // Close modal function
            function closeModal() {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }

            // Remove old listeners by cloning
            var newOverlay = overlay.cloneNode(true);
            overlay.parentNode.replaceChild(newOverlay, overlay);
            newOverlay.addEventListener('click', closeModal);

            var newCloseBtn = closeBtn.cloneNode(true);
            closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
            newCloseBtn.addEventListener('click', closeModal);

            // Close with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                    closeModal();
                }
            });
        }

        // Country code to full name mapping
        var countryNames = {
            'us': 'United States',
            'uk': 'United Kingdom',
            'gb': 'United Kingdom',
            'jp': 'Japan',
            'kr': 'South Korea',
            'cn': 'China',
            'fr': 'France',
            'de': 'Germany',
            'es': 'Spain',
            'it': 'Italy',
            'ca': 'Canada',
            'au': 'Australia',
            'br': 'Brazil',
            'mx': 'Mexico',
            'in': 'India',
            'ru': 'Russia',
            'se': 'Sweden',
            'no': 'Norway',
            'dk': 'Denmark',
            'fi': 'Finland',
            'nl': 'Netherlands',
            'be': 'Belgium',
            'ch': 'Switzerland',
            'at': 'Austria',
            'pl': 'Poland',
            'pt': 'Portugal',
            'ie': 'Ireland',
            'nz': 'New Zealand',
            'za': 'South Africa',
            'ar': 'Argentina',
            'cl': 'Chile',
            'co': 'Colombia',
            'tw': 'Taiwan',
            'hk': 'Hong Kong',
            'sg': 'Singapore',
            'th': 'Thailand',
            'id': 'Indonesia',
            'my': 'Malaysia',
            'ph': 'Philippines',
            'vn': 'Vietnam',
            'tr': 'Turkey',
            'eg': 'Egypt',
            'il': 'Israel',
            'ae': 'United Arab Emirates',
            'sa': 'Saudi Arabia'
        };

        // Format date to "Mon YYYY" format
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                var date = new Date(dateString);
                if (isNaN(date.getTime())) return 'N/A';
                var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return months[date.getMonth()] + ' ' + date.getFullYear();
            } catch (e) {
                return 'N/A';
            }
        }

        // Get full country name from code
        function getCountryName(code) {
            if (!code) return null;
            var lowerCode = code.toLowerCase();
            return countryNames[lowerCode] || code.toUpperCase();
        }

        // Format runtime from minutes to "Xh Ym" format
        function formatRuntime(minutes) {
            if (!minutes || minutes <= 0) return null;
            var hours = Math.floor(minutes / 60);
            var mins = minutes % 60;
            if (hours === 0) {
                return mins + 'm';
            } else if (mins === 0) {
                return hours + 'h';
            } else {
                return hours + 'h ' + mins + 'm';
            }
        }

        // Open modal with data - exposed globally
        window.openModalViewed = function(data) {
            var modal = document.getElementById('modal-viewed');
            if (!modal) return;

            // Get elements
            var title = document.getElementById('modal-title');
            var poster = document.getElementById('modal-poster');
            var dateEl = document.querySelector('#modal-date .date-value');
            var dateContainer = document.getElementById('modal-date');
            var ratingEl = document.querySelector('#modal-rating .rating-value');
            var ratingContainer = document.getElementById('modal-rating');
            var runtimeEl = document.querySelector('#modal-runtime .runtime-value');
            var runtimeContainer = document.getElementById('modal-runtime');
            var platformEl = document.querySelector('#modal-platform .platform-value');
            var platformContainer = document.getElementById('modal-platform');
            var genresContainer = document.getElementById('modal-genres');
            var genresWrapper = document.getElementById('modal-genres-container');
            var overview = document.getElementById('modal-overview');
            var trailerContainer = document.getElementById('modal-trailer-container');
            var trailerLink = document.getElementById('modal-trailer-link');

            // Title
            if (title) title.textContent = data.title || 'Sin título';

            // Banner (header background)
            var bannerEl = document.getElementById('modal-banner');
            var bannerContainer = document.getElementById('modal-banner-container');
            if (bannerEl && bannerContainer) {
                if (data.banner) {
                    bannerEl.setAttribute('src', data.banner);
                    bannerContainer.classList.remove('hidden');
                } else {
                    bannerContainer.classList.add('hidden');
                }
            }
            
            // Poster
            if (poster) {
                poster.setAttribute('src', data.poster || 'https://placehold.co/224x336?text=No+Poster');
                poster.setAttribute('alt', data.title || 'Poster');
            }

            // Logo
            var logoEl = document.getElementById('modal-logo');
            var logoContainer = document.getElementById('modal-logo-container');
            if (logoEl && logoContainer) {
                if (data.logo) {
                    logoEl.setAttribute('src', data.logo);
                    logoEl.setAttribute('alt', (data.title || 'Logo') + ' logo');
                    logoContainer.classList.remove('hidden');
                } else {
                    logoContainer.classList.add('hidden');
                }
            }
            
            // Release Date (month and year)
            if (dateEl && dateContainer) {
                var formattedDate = formatDate(data.releaseDate);
                if (formattedDate !== 'N/A') {
                    dateEl.textContent = formattedDate;
                    dateContainer.classList.remove('hidden');
                } else {
                    dateContainer.classList.add('hidden');
                }
            }
            
            // Rating
            if (ratingEl && ratingContainer) {
                if (data.rating) {
                    ratingEl.textContent = String(data.rating);
                    ratingContainer.classList.remove('hidden');
                } else {
                    ratingContainer.classList.add('hidden');
                }
            }

            // Runtime
            if (runtimeEl && runtimeContainer) {
                if (data.runtime) {
                    runtimeEl.textContent = String(data.runtime);
                    runtimeContainer.classList.remove('hidden');
                } else {
                    runtimeContainer.classList.add('hidden');
                }
            }

            // Platform
            if (platformEl && platformContainer) {
                if (data.platform) {
                    platformEl.textContent = String(data.platform);
                    platformContainer.classList.remove('hidden');
                } else {
                    platformContainer.classList.add('hidden');
                }
            }

            // Episodes (solo para series)
            var episodesEl = document.querySelector('#modal-episodes .episodes-value');
            var episodesContainer = document.getElementById('modal-episodes');
            if (episodesEl && episodesContainer) {
                if (data.episodes) {
                    episodesEl.textContent = String(data.episodes);
                    episodesContainer.classList.remove('hidden');
                } else {
                    episodesContainer.classList.add('hidden');
                }
            }

            // Total Runtime (solo para series) - formatted as hours and minutes
            var totalRuntimeEl = document.querySelector('#modal-total-runtime .total-runtime-value');
            var totalRuntimeContainer = document.getElementById('modal-total-runtime');
            if (totalRuntimeEl && totalRuntimeContainer) {
                var formattedTotalRuntime = formatRuntime(data.totalRuntime);
                if (formattedTotalRuntime) {
                    totalRuntimeEl.textContent = formattedTotalRuntime;
                    totalRuntimeContainer.classList.remove('hidden');
                } else {
                    totalRuntimeContainer.classList.add('hidden');
                }
            }

            // Country (full name)
            var countryEl = document.querySelector('#modal-country .country-value');
            var countryContainer = document.getElementById('modal-country');
            if (countryEl && countryContainer) {
                var countryName = getCountryName(data.country);
                if (countryName) {
                    countryEl.textContent = countryName;
                    countryContainer.classList.remove('hidden');
                } else {
                    countryContainer.classList.add('hidden');
                }
            }

            // Genres
            if (genresContainer && genresWrapper) {
                genresContainer.innerHTML = '';
                if (data.genres && data.genres.length > 0) {
                    data.genres.forEach(function(genre) {
                        var badge = document.createElement('span');
                        badge.className = 'px-2.5 py-1 text-xs bg-gray-800 border border-gray-600 rounded-full text-gray-400';
                        badge.textContent = genre;
                        genresContainer.appendChild(badge);
                    });
                    genresWrapper.classList.remove('hidden');
                } else {
                    genresWrapper.classList.add('hidden');
                }
            }

            // Director
            var directorEl = document.querySelector('#modal-director .director-value');
            var directorContainer = document.getElementById('modal-director-container');
            if (directorEl && directorContainer) {
                if (data.director) {
                    directorEl.textContent = data.director;
                    directorContainer.classList.remove('hidden');
                } else {
                    directorContainer.classList.add('hidden');
                }
            }

            // Actors (with character names) - grid 2 columns layout
            var actorsContainer = document.getElementById('modal-actors');
            var actorsWrapper = document.getElementById('modal-actors-container');
            if (actorsContainer && actorsWrapper) {
                actorsContainer.innerHTML = '';
                if (data.actors && data.actors.length > 0) {
                    data.actors.forEach(function(actor) {
                        // Handle both old format (string) and new format (object with name and character)
                        var actorName = typeof actor === 'string' ? actor : actor.name;
                        var characterName = typeof actor === 'object' && actor.character ? actor.character : null;
                        
                        var card = document.createElement('div');
                        card.className = 'flex flex-col px-3 py-2 bg-gray-800/50 border border-gray-700 rounded-lg';
                        
                        var nameHtml = '<span class="text-sm font-medium text-gray-200 truncate">' + actorName + '</span>';
                        var characterHtml = characterName 
                            ? '<span class="text-xs text-gray-500 truncate">as ' + characterName + '</span>' 
                            : '';
                        
                        card.innerHTML = nameHtml + characterHtml;
                        actorsContainer.appendChild(card);
                    });
                    actorsWrapper.classList.remove('hidden');
                } else {
                    actorsWrapper.classList.add('hidden');
                }
            }

            // Overview
            if (overview) overview.textContent = data.overview || 'Sin descripción disponible.';

            // Trailer
            if (trailerContainer && trailerLink) {
                if (data.trailer) {
                    trailerLink.setAttribute('href', data.trailer);
                    trailerContainer.classList.remove('hidden');
                } else {
                    trailerContainer.classList.add('hidden');
                }
            }

            // Show modal
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };

        // Initialize
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initModal);
        } else {
            initModal();
        }
        document.addEventListener('astro:after-swap', initModal);
    })();
</script>
