---
export const prerender = true;

import { getCollection, render } from "astro:content";
import Layout from "../../layouts/Layout.astro";

import IconPlayerPlay from "../../icons/PlayerPlay.astro";
import IconCalendarCheck from "../../icons/CalendarCheck.astro";
import IconTagsIcon from "../../icons/TagsIcon.astro";
import IconNetwork from "../../icons/Network.astro";
import IconDeviceGamepad from "../../icons/DeviceGamepad.astro";
import IconStopwatch from "../../icons/Stopwatch.astro";
import IconCircleDashed from "../../icons/CircleDashed.astro";
import IconTrophy from "../../icons/Trophy.astro";
import IconNumber from "../../icons/Number.astro";
import IconCalendarTime from "../../icons/CalendarTime.astro";
import IconPuzzle from "../../icons/Puzzle.astro";
import FileDescription from "../../icons/FileDescription.astro";
import ImagenGames from "../../components/ImagenGames.astro";
import VideoTrailer from "../../components/VideoTrailer.astro";
import IconVideo from "../../icons/IconVideo.astro";

export async function getStaticPaths() {
    const games = await getCollection("games");

    return games.map((game) => ({
        params: { id: game.slug },
        props: { game }
    }))
}

const { game } = Astro.props
const { slug, data } = game
const { title, released, companie, poster, trailer, genre, estado, horasTotal, logros_obt, logros_total, console_pc, igdbId, dates_played } = data
const { Content } = await render(game)

// Definimos un valor por defecto para year en SSG
const defaultYear = "2025";
const defaultYearKey = `y${defaultYear}`;

const ImgUrl = "https://images.igdb.com/igdb/image/upload/t_1080p/";

let percentTrofeos;
if (logros_obt === 0 && logros_total === 0) {
    percentTrofeos = 100;
} else {
    percentTrofeos = Math.round((logros_obt / logros_total) * 100);
}

const estadoStyles = {
    completado: { className: 'completadoColorBg', iconColor: '#2973B2' },
    pausado: { className: 'pausadoColorBg', iconColor: '#FFD65A' },
    jugando: { className: 'jugandoColorBg', iconColor: '#16C47F' },
    abandonado: { className: 'abandonadoColorBg', iconColor: '#D84040' }
};

const currentEstado = estadoStyles[estado.toLowerCase()] || { className: 'defaultColorBg', iconColor: '#FFFFFF' };

const estadoStyle = currentEstado.iconColor;

---

<Layout title={`${title} - BURST`}>
    <main class="w-full">
        
        <section class="p-4 mx-auto max-w-screen-xl">

            <a href="javascript:history.back()" class="text-lg font-mono text-gray-300 border py-1 px-2 rounded-md bg-gray-800 border-gray-700 lg:hover:bg-gray-700">↩️ Back</a>

            <div class="flex gap-4 flex-col lg:flex-row pt-3">

                <aside class="flex flex-col items-center w-full">
                    <img transition:name={`img-${slug}`} src={ImgUrl + poster} alt={title} class="rounded-xl w-72 h-auto w-full" loading="lazy">
                </aside>

                <main class="max-w-3xl prose prose-invert w-full">

                    <div class="bg-[#1b1e25] p-2 rounded-xl mb-3">
                        <h2 class="flex items-center gap-2 text-2xl font-bold mb-4">
                            {title}
                            <IconPlayerPlay width="30" height="30" stroke={estadoStyle} />
                        </h2>

                        <li class="flex items-center gap-2">
                            <span style={`color:${estadoStyle};`}><IconNumber width="20" height="20" /></span>
                            <span class="font-bold">igdbId:</span> 
                            {igdbId}
                        </li>
                        <li class="flex items-center gap-2">
                            <span style={`color:${estadoStyle};`}><IconCalendarCheck width="20" height="20" /></span>
                            <span class="font-bold"> Lanzamiento: </span> 
                            {released}
                        </li>
                        <li class="flex items-center gap-2">
                            <span style={`color:${estadoStyle};`}><IconNetwork width="20" height="20" /></span>
                            <span class="font-bold">Compañía:</span> 
                            {companie}
                        </li>
                        <li class="flex items-center gap-2">
                            <span style={`color:${estadoStyle};`}><IconTagsIcon width="20" height="20" /></span>
                            <span class="font-bold ">Generos:</span> 
                            <span class="truncate">{genre}</span>
                        </li>
                        <li class="flex items-center gap-2">
                            <span style={`color:${estadoStyle};`}><IconDeviceGamepad width="20" height="20" /></span>
                            <span class="font-bold">Consola/PC:</span> 
                            {console_pc}
                        </li>
                        <li class="flex items-center gap-2">
                            <span style={`color:${estadoStyle};`}><IconCircleDashed width="20" height="20" /></span>
                            <span class="font-bold">Estado:</span> 
                            {estado}
                        </li>
                        <li class="flex items-center gap-2">
                            <span style={`color:${estadoStyle};`}><IconStopwatch width="20" height="20" /></span>
                            <span class="font-bold">Horas jugadas:</span> 
                            {horasTotal} hrs
                        </li>
                        <li class="flex items-center gap-2">
                            <span style={`color:${estadoStyle};`}><IconCalendarTime width="20" height="20" /></span>
                            <span class="font-bold">Fecha de inicio:</span> 
                            <!-- Se asigna id para actualización en cliente -->
                            <span id="fecha_inicio">{dates_played[defaultYearKey]?.fecha_inicio}</span>
                        </li>
                        <li class="flex items-center gap-2">
                            <span style={`color:${estadoStyle};`}><IconCalendarTime width="20" height="20" /></span>
                            <span class="font-bold">Fecha de finalización:</span> 
                            <!-- Se asigna id para actualización en cliente -->
                            <span id="fecha_final">{dates_played[defaultYearKey]?.fecha_final ? dates_played[defaultYearKey]?.fecha_final : "En progreso"}</span>
                        </li>

                        <!-- <article>
                            <div class="w-full bg-gray-200 rounded-md dark:bg-gray-700">
                                <div class={`bar ${currentEstado.className} text-md font-medium text-white text-center p-0.5 leading-none rounded-md flex items-center justify-center font-mono`} style={`width: 30%;`}> 30 Dias </div>
                            </div>
                        </article> -->

                        <li class="flex items-center gap-2">
                            <span style={`color:${estadoStyle};`}><IconTrophy width="20" height="20" /></span>
                            <span class="font-bold">Logros obtenidos:</span>
                            {logros_obt} / {logros_total}
                        </li>

                        <article class="mt-2">
                            <div class="progress-container">
                                <div class="progress-background">
                                    <div
                                        class={`progress-bar ${currentEstado.className}`}
                                        style={`width: ${percentTrofeos}%;`}
                                        role="progressbar"
                                        aria-valuenow={percentTrofeos}
                                        aria-valuemin="0"
                                        aria-valuemax="100"
                                    >
                                        <span class="progress-content">
                                            {percentTrofeos >= 20 && (
                                                <>
                                                    <span class="progress-percentage">{percentTrofeos}%</span>
                                                    <span class="progress-icon-wrapper">
                                                        <IconPuzzle width="18" height="18" />
                                                    </span>
                                                </>
                                            )}
                                        </span>
                                    </div>
                                </div>
                                {percentTrofeos < 20 && percentTrofeos >= 10 && (
                                    <span class="progress-label-outside-20">
                                        <span class="progress-text">{percentTrofeos}%</span>
                                        <span class="progress-icon-wrapper">
                                            <IconPuzzle width="16" height="16" />
                                        </span>
                                    </span>
                                )}
                                {percentTrofeos < 10 && (
                                    <span class="progress-label-outside-10">
                                        <span class="progress-text">{percentTrofeos}%</span>
                                        <span class="progress-icon-wrapper">
                                            <IconPuzzle width="16" height="16" />
                                        </span>
                                    </span>
                                )}
                            </div>
                        </article>
                    </div>

                    <aside class="bg-[#1b1e25] rounded-xl p-5">
                        <p class="text-xl flex items-center gap-2">
                            <FileDescription width="20" height="20" stroke={estadoStyle} />
                            Descripción:
                        </p>
                        <Content />
                    </aside>

                </main>
            </div>
        </section>

        <!-- Contenedor oculto con la data de dates_played para uso en cliente -->
        <div id="dates-data" class="hidden" data-dates={JSON.stringify(dates_played)}></div>

        <section class="p-4 mx-auto max-w-screen-xl py-8">
            <hr>
        </section>

        <section class="p-4 mx-auto max-w-screen-xl ">
            <div class="bg-[#1b1e25] rounded-xl p-5">
                <p class="text-xl flex items-center gap-2 mb-5">
                    <IconVideo width="20" height="20" stroke={estadoStyle} />
                    Trailer:
                </p>
                <VideoTrailer slug={trailer} />
            </div>
        </section>

    </main>
</Layout>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const datesElement = document.getElementById('dates-data');
        const datesData = datesElement ? JSON.parse(datesElement.dataset.dates || '{}') : {};
        const params = new URLSearchParams(window.location.search);
        const selectedYear = params.get("year") || "2025";
        const yearKey = `y${selectedYear}`;
        const fechaInicioEl = document.getElementById("fecha_inicio");
        const fechaFinalEl = document.getElementById("fecha_final");
        if (datesData[yearKey] && fechaInicioEl && fechaFinalEl) {
            fechaInicioEl.textContent = datesData[yearKey].fecha_inicio;
            fechaFinalEl.textContent = datesData[yearKey].fecha_final || "En progreso";
        }
    });
</script>

<style>
    /* Progress Bar Styles */
    .progress-container {
        position: relative;
        width: 100%;
    }

    .progress-background {
        width: 100%;
        height: 32px;
        background: linear-gradient(to right, rgba(55, 65, 81, 0.5), rgba(75, 85, 99, 0.5));
        border-radius: 8px;
        overflow: hidden;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        position: relative;
    }

    .progress-bar {
        height: 100%;
        border-radius: 8px;
        transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        min-width: 2px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }

    .progress-bar::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
            90deg,
            rgba(255, 255, 255, 0) 0%,
            rgba(255, 255, 255, 0.2) 50%,
            rgba(255, 255, 255, 0) 100%
        );
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    .progress-content {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        height: 100%;
        font-weight: 600;
        font-size: 0.875rem;
        letter-spacing: 0.025em;
        position: relative;
        z-index: 1;
    }

    .progress-percentage {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        color: white;
    }

    .progress-icon-wrapper {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: white;
        filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5));
    }

    .progress-icon-wrapper svg {
        fill: white;
        stroke: white;
    }

    .progress-label-outside-20 {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        font-weight: bold;
        font-size: 0.875rem;
        font-family: 'Courier New', monospace;
        display: flex;
        align-items: center;
        gap: 6px;
        color: white;
        /*
        border-radius: 6px;
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(0, 0, 0, 0.6);
        padding: 4px 10px; 
        */
    }

    .progress-label-outside-10 {
        position: absolute;
        left: 40px;
        top: 50%;
        transform: translateY(-50%);
        font-weight: bold;
        font-size: 0.875rem;
        font-family: 'Courier New', monospace;
        display: flex;
        align-items: center;
        gap: 6px;
        color: white;
        /*
        border-radius: 6px;
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(0, 0, 0, 0.6);
        padding: 4px 10px; 
        */
    }

    .progress-text {
        color: white;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
    }

    /* Estado Colors */
    .completadoColorBg {
        color: white;
        &.bar {
            background-color: #2973B2;
        }
        &.progress-bar {
            background: linear-gradient(90deg, #2973B2 0%, #3a8fd9 100%);
        }
        &.icon {
            fill: #2973B2;
        }
    }

    .pausadoColorBg {
        color: white;
        &.bar {
            background-color: #FFD65A;
        }
        &.progress-bar {
            background: linear-gradient(90deg, #FFD65A 0%, #ffe080 100%);
        }
        &.icon {
            fill: #FFD65A;
        }
    }

    .jugandoColorBg {
        color: white;
        &.bar {
            background-color: #16C47F;
        }
        &.progress-bar {
            background: linear-gradient(90deg, #16C47F 0%, #2de69d 100%);
        }
        &.icon {
            fill: #16C47F;
        }
    }

    .abandonadoColorBg {
        color: white;
        &.bar {
            background-color: #D84040;
        }
        &.progress-bar {
            background: linear-gradient(90deg, #D84040 0%, #e86060 100%);
        }
        &.icon {
            fill: #D84040;
        }
    }

    .defaultColorBg {
        color: white;
        &.bar {
            background-color: #333;
        }
        &.progress-bar {
            background: linear-gradient(90deg, #333 0%, #444 100%);
        }
        &.icon {
            fill: #333;
        }
    }
</style>