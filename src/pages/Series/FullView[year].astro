---
import Layout from '../../layouts/Layout.astro';
import CarruselCardsTrakt from '../../components/CarruselCardsTrakt.astro';
import YearNavigation from '../../components/YearNavigation.astro';
import { getSeriesSeasonsByYear } from '../../services/apiSeries.js';
import { ListSeriesSeasons, getAvailableYears } from '../../data/seriesSeasons.js';

const years = getAvailableYears();

export function getStaticPaths() {
    return getAvailableYears().map(year => ({
        params: { year: year.toString() }
    }));
}

const { year } = Astro.params;
const currentYear = parseInt(year);
const { series, error } = await getSeriesSeasonsByYear(ListSeriesSeasons, currentYear);

// Obtener datos de la primera serie para el estado inicial
const firstSeries = series[0];
const initialFanart = firstSeries?.season?.images?.fanart?.[0] 
    ? `https://${firstSeries.season.images.fanart[0]}`.replace('/medium/', '/full/')
    : (firstSeries?.show?.images?.fanart?.[0] 
        ? `https://${firstSeries.show.images.fanart[0]}`.replace('/medium/', '/full/') 
        : '');
const initialTitle = firstSeries?.show?.title || '';
const initialSeason = firstSeries?.numberSeason || '';
const initialreleaseDate = firstSeries?.season?.first_aired || firstSeries?.show?.first_aired || null;
const formattedReleaseDate = initialreleaseDate 
    ? new Date(initialreleaseDate).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })
    : null;
const initialplatform = firstSeries?.platformViewed || null;
const initialrating = '';
// Función para formatear minutos a horas y minutos
const formatRuntime = (totalMinutes) => {
    if (!totalMinutes) return '';
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    if (hours > 0 && minutes > 0) return `${hours}h ${minutes}m`;
    if (hours > 0) return `${hours}h`;
    return `${minutes}m`;
};
// Calcular runtime combinado: "Total runtime: 5h 12m (13 episodes 24m/ep)"
const initialRuntimePerEp = firstSeries?.show?.runtime || 0;
const initialEpisodeCount = firstSeries?.season?.episode_count || 0;
const initialTotalMinutes = initialRuntimePerEp * initialEpisodeCount;
const initialRuntimeFormatted = initialTotalMinutes && initialEpisodeCount && initialRuntimePerEp
    ? `${initialEpisodeCount} episodes ${initialRuntimePerEp}m/ep (${formatRuntime(initialTotalMinutes)} total)`
    : '';
const initialgenres = firstSeries?.show?.genres || [];
const initialoverview = '';
const initialtrailer = '';
const initialcertification = firstSeries?.show?.certification || '';
const initialepisodes = firstSeries?.season?.episode_count || '';
const initialactors = firstSeries?.show?.actors || '';
const initialcharacter = firstSeries?.show?.actors?.map(actor => actor.character).join(', ') || '';
const initialdirector = firstSeries?.show?.director || '';
// Función para convertir código de país a nombre completo
const getCountryName = (countryCode) => {
    if (!countryCode) return '';
    try {
        const regionNames = new Intl.DisplayNames(['en'], { type: 'region' });
        return regionNames.of(countryCode.toUpperCase());
    } catch (e) {
        return countryCode;
    }
};
const initialcountry = getCountryName(firstSeries?.show?.country);

---
<Layout title={`BURST Series - FullView ${year}`}>
    <main 
        id="main-bg" 
        class="bg-cover bg-center transition-opacity duration-500 main-height"
        style={`background-image: url('${initialFanart}');`}
    >

    <!-- <pre class="debdug-json" id="debug-jsson">
        {JSON.stringify(series[2], null, 2)}
    </pre> -->

        <!-- Overlay oscuro para mejorar legibilidad -->
        <div class="bg-black/50 main-height">
            <div class="mx-auto flex flex-col justify-between h-full main-height p-4">

                <div class="flex flex-col xl:flex-row items-start xl:items-center justify-between gap-3">
                    <div>
                        <h2 class="text-xs lg:text-4xl font-bold text-white text-start flex align-center items-center">
                            <span id="series-title" class="transition-opacity duration-300 FiraCodeFont">
                                {initialTitle}{initialcertification ? <span class="text-xs lg:text-xs font-normal FiraCodeFont">{initialcertification}</span> : ''}
                            </span>
                        </h2>
                        <p id="series-season" class="text-xs lg:text-lg text-white text-start transition-opacity duration-300 FiraCodeFont">
                            {initialSeason ? <><span class="font-bold">Season {initialSeason}</span></> : ''} <span class="text-xs">by {initialdirector ? <>{initialdirector}</> : ''}</span>
                        </p>
                        <p id="series-release-date" class="text-xs lg:text-xs text-white text-start transition-opacity duration-300 FiraCodeFont">
                            {formattedReleaseDate ? <>{formattedReleaseDate}</> : ''} - {initialplatform ? <>{initialplatform}</> : ''} - {initialcountry ? <>{initialcountry}</> : ''}
                        </p>
                        <p id="series-runtime" class="text-xs lg:text-xs text-white text-start transition-opacity duration-300 FiraCodeFont">
                            {initialRuntimeFormatted ? <>{initialRuntimeFormatted.replace('Total runtime: ', '')}</> : ''}
                        </p>
                        <div id="series-genres" class="flex flex-row flex-wrap gap-1 text-xs lg:text-xs text-white text-start transition-opacity duration-300 FiraCodeFont capitalize">
                            {initialgenres.map(genre => (
                                <span class="bg-sky-900/30 px-2 py-1 inline-block rounded-md">{genre}</span>
                            ))}
                        </div>
                        <div id="series-actors" class="flex flex-row items-start gap-4 pt-2 overflow-x-auto">
                            {initialactors?.slice(0, 4).map(actor => (
                                <article class="flex flex-col items-center">
                                    <img class="w-[50px] rounded-lg"
                                    src={`https://${actor.headshot}`} alt={actor.name}>
                                    <p class="text-xs lg:text-xs text-white text-start transition-opacity duration-300 FiraCodeFont">
                                        {actor.name}
                                    </p>
                                    <p class="text-xs lg:text-xs text-white text-start transition-opacity duration-300 FiraCodeFont">
                                        {actor.character}
                                    </p>
                                </article>
                            ))}
                        </div>
                    </div>
                </div>

                <div class="mt-auto">
                    <CarruselCardsTrakt series={series} />
                </div>
                
            </div>
        </div>
    </main>
</Layout>

<style>
    /* Altura del contenido restando el nav de 53px */
    .main-height {
        min-height: calc(100dvh - 53px);
    }

    /* Transición suave para el fondo */
    #main-bg {
        transition: background-image 0.5s ease-in-out, opacity 0.5s ease-in-out;
        background-position: center;
        background-size: cover;
    }

    /* Clase para fade out */
    #main-bg.fade-out {
        opacity: 0.7;
    }

    /* Transición para el título y metadatos */
    #series-title,
    #series-release-date,
    #series-season,
    #series-platform,
    #series-runtime,
    #series-genres,
    #series-actors,
    #series-director,
    #series-country {
        transition: opacity 0.3s ease-in-out;
    }

    #series-title.fade-out,
    #series-release-date.fade-out,
    #series-season.fade-out,
    #series-platform.fade-out,
    #series-runtime.fade-out,
    #series-genres.fade-out,
    #series-actors.fade-out,
    #series-director.fade-out,
    #series-country.fade-out {
        opacity: 0;
    }
</style>

<script is:inline>
(function() {
    function initFullView() {
        const mainBg = document.getElementById('main-bg');
        const seriesTitle = document.getElementById('series-title');
        const seriesReleaseDate = document.getElementById('series-release-date');
        const seriesSeason = document.getElementById('series-season');
        const seriesPlatform = document.getElementById('series-platform');
        const seriesRuntime = document.getElementById('series-runtime');
        const seriesGenres = document.getElementById('series-genres');
        const seriesActors = document.getElementById('series-actors');
        const seriesDirector = document.getElementById('series-director');
        const seriesCountry = document.getElementById('series-country');
        
        // Array de todos los elementos de metadata para facilitar operaciones
        const metadataElements = [
            seriesTitle, seriesReleaseDate, seriesSeason, seriesPlatform,
            seriesRuntime, seriesGenres, seriesActors,
            seriesDirector, seriesCountry
        ].filter(el => el !== null);
        
        if (!mainBg || !seriesTitle) return;

        // Formatear fecha a mes completo y año en inglés
        function formatReleaseDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            } catch (e) {
                return '';
            }
        }

        // Convertir código de país a nombre completo
        function getCountryName(countryCode) {
            if (!countryCode) return '';
            try {
                const regionNames = new Intl.DisplayNames(['en'], { type: 'region' });
                return regionNames.of(countryCode.toUpperCase());
            } catch (e) {
                return countryCode;
            }
        }

        // Formatear minutos a horas y minutos
        function formatMinutesToHours(totalMinutes) {
            if (!totalMinutes) return '';
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            if (hours > 0 && minutes > 0) return `${hours}h ${minutes}m`;
            if (hours > 0) return `${hours}h`;
            return `${minutes}m`;
        }

        // Formatear runtime completo: "13 episodes 24m/ep (5h 12m total)"
        function formatRuntimeComplete(runtime, episodeCount) {
            if (!runtime || !episodeCount) return '';
            const totalMinutes = parseInt(runtime) * parseInt(episodeCount);
            return `${episodeCount} episodes ${runtime}m/ep (${formatMinutesToHours(totalMinutes)} total)`;
        }

        // Manejar cambio de card activa
        function handleCarruselChange(event) {
            const { fanart, title, season, releaseDate, platform, runtime, episodeCount, genres, actors, director, country, certification } = event.detail;

            // Fade out de todos los elementos
            metadataElements.forEach(el => el.classList.add('fade-out'));

            // Fade out del fondo
            mainBg.classList.add('fade-out');

            // Después de la transición, cambiar contenido
            setTimeout(() => {
                // Actualizar fondo
                if (fanart) {
                    mainBg.style.backgroundImage = `url('${fanart}')`;
                }

                // Actualizar título con certification
                if (seriesTitle) {
                    const certSpan = certification ? `<span class="text-xs lg:text-xs font-normal FiraCodeFont">${certification}</span>` : '';
                    seriesTitle.innerHTML = (title || '') + certSpan;
                }

                // Actualizar temporada y director
                if (seriesSeason) {
                    const seasonPart = season ? `<span class="font-bold">Season ${season}</span>` : '';
                    const directorPart = director ? `<span class="text-xs">by ${director}</span>` : '';
                    seriesSeason.innerHTML = `${seasonPart} ${directorPart}`;
                }

                // Actualizar fecha, plataforma y país
                if (seriesReleaseDate) {
                    const formattedDate = formatReleaseDate(releaseDate);
                    const countryName = getCountryName(country);
                    const parts = [formattedDate, platform, countryName].filter(Boolean);
                    seriesReleaseDate.innerHTML = parts.join(' - ');
                }

                // Actualizar runtime
                if (seriesRuntime) {
                    seriesRuntime.innerHTML = formatRuntimeComplete(runtime, episodeCount);
                }

                // Actualizar géneros
                if (seriesGenres) {
                    if (genres) {
                        const genresArray = genres.split(', ').filter(Boolean);
                        seriesGenres.innerHTML = genresArray.map(genre =>
                            `<span class="bg-sky-900/30 px-2 py-1 inline-block rounded-md">${genre}</span>`
                        ).join('');
                    } else {
                        seriesGenres.innerHTML = '';
                    }
                }

                // Actualizar actores
                if (seriesActors) {
                    try {
                        const actorsArray = typeof actors === 'string' ? JSON.parse(actors) : actors;
                        if (Array.isArray(actorsArray) && actorsArray.length > 0) {
                            seriesActors.innerHTML = actorsArray.map(actor => `
                                <article class="flex flex-col items-center">
                                    <img class="w-[50px] rounded-lg"
                                         src="${actor.headshot ? 'https://' + actor.headshot : ''}"
                                         alt="${actor.name || ''}"
                                         onerror="this.style.display='none'">
                                    <p class="text-xs lg:text-xs text-white text-start transition-opacity duration-300 FiraCodeFont">
                                        ${actor.name || ''}
                                    </p>
                                    <p class="text-xs lg:text-xs text-white text-start transition-opacity duration-300 FiraCodeFont">
                                        ${actor.character || ''}
                                    </p>
                                </article>
                            `).join('');
                        } else {
                            seriesActors.innerHTML = '';
                        }
                    } catch (e) {
                        seriesActors.innerHTML = '';
                    }
                }

                // Fade in de todos los elementos
                mainBg.classList.remove('fade-out');
                metadataElements.forEach(el => el.classList.remove('fade-out'));
            }, 300);
        }

        // Manejar inicialización del carrusel
        function handleCarruselInit(event) {
            const { fanart, title, season } = event.detail;
            
            // Setear valores iniciales sin animación
            if (fanart) {
                mainBg.style.backgroundImage = `url('${fanart}')`;
            }
            
            seriesTitle.textContent = title || '';
        }

        // Escuchar eventos del carrusel
        document.addEventListener('carrusel:change', handleCarruselChange);
        document.addEventListener('carrusel:init', handleCarruselInit);
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initFullView);
    } else {
        initFullView();
    }
    document.addEventListener('astro:after-swap', initFullView);
})();
</script>
