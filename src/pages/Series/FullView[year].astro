---
import Layout from '../../layouts/Layout.astro';
import CarruselCardsTrakt from '../../components/CarruselCardsTrakt.astro';
import YearNavigation from '../../components/YearNavigation.astro';
import { getSeriesSeasonsByYear } from '../../services/apiSeries.js';
import { ListSeriesSeasons, getAvailableYears } from '../../data/seriesSeasons.js';

const years = getAvailableYears();

export function getStaticPaths() {
    return getAvailableYears().map(year => ({
        params: { year: year.toString() }
    }));
}

const { year } = Astro.params;
const currentYear = parseInt(year);
const { series, error } = await getSeriesSeasonsByYear(ListSeriesSeasons, currentYear);

// Obtener datos de la primera serie para el estado inicial
const firstSeries = series[0];
const initialFanart = firstSeries?.season?.images?.fanart?.[0] 
    ? `https://${firstSeries.season.images.fanart[0]}`.replace('/medium/', '/full/')
    : (firstSeries?.show?.images?.fanart?.[0] 
        ? `https://${firstSeries.show.images.fanart[0]}`.replace('/medium/', '/full/') 
        : '');
const initialTitle = firstSeries?.show?.title || '';
const initialSeason = firstSeries?.numberSeason || '';
const initialreleaseDate = firstSeries?.season?.first_aired || firstSeries?.show?.first_aired || null;
const formattedReleaseDate = initialreleaseDate 
    ? new Date(initialreleaseDate).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })
    : null;
const initialplatform = firstSeries?.platformViewed || null;
const initialrating = '';
// Función para formatear minutos a horas y minutos
const formatRuntime = (totalMinutes) => {
    if (!totalMinutes) return '';
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    if (hours > 0 && minutes > 0) return `${hours}h ${minutes}m`;
    if (hours > 0) return `${hours}h`;
    return `${minutes}m`;
};
// Calcular runtime combinado: "Total runtime: 5h 12m (13 episodes 24m/ep)"
const initialRuntimePerEp = firstSeries?.show?.runtime || 0;
const initialEpisodeCount = firstSeries?.season?.episode_count || 0;
const initialTotalMinutes = initialRuntimePerEp * initialEpisodeCount;
const initialRuntimeFormatted = initialTotalMinutes && initialEpisodeCount && initialRuntimePerEp
    ? `Total runtime: ${formatRuntime(initialTotalMinutes)} (${initialEpisodeCount} episodes ${initialRuntimePerEp}m/ep)`
    : '';
const initialgenres = firstSeries?.show?.genres?.join(', ') || '';
const initialoverview = '';
const initialtrailer = '';
const initialepisodes = firstSeries?.season?.episode_count || '';
const initialactors = firstSeries?.show?.actors?.map(actor => actor.name).join(', ') || '';
const initialdirector = firstSeries?.show?.director || '';
// Función para convertir código de país a nombre completo
const getCountryName = (countryCode) => {
    if (!countryCode) return '';
    try {
        const regionNames = new Intl.DisplayNames(['en'], { type: 'region' });
        return regionNames.of(countryCode.toUpperCase());
    } catch (e) {
        return countryCode;
    }
};
const initialcountry = getCountryName(firstSeries?.show?.country);

---
<Layout title={`BURST Series - FullView ${year}`}>
    <main 
        id="main-bg" 
        class="bg-cover bg-center transition-opacity duration-500 main-height"
        style={`background-image: url('${initialFanart}');`}
    >
        <!-- Overlay oscuro para mejorar legibilidad -->
        <div class="bg-black/50 main-height">
            <div class="mx-auto flex flex-col justify-between h-full main-height p-4">

                <div class="flex flex-col xl:flex-row items-start xl:items-center justify-between gap-3">
                    <div>
                        <h2 class="text-md lg:text-2xl font-bold text-white text-start flex align-center items-center">
                            <span id="series-title" class="transition-opacity duration-300 FiraCodeFont">
                                {initialTitle}
                            </span>
                        </h2>
                        <p id="series-season" class="text-md lg:text-lg text-white text-start transition-opacity duration-300 FiraCodeFont">
                            {initialSeason ? <><strong>Season</strong> {initialSeason}</> : ''}
                        </p>
                        <p id="series-release-date" class="text-sm lg:text-md text-white text-start transition-opacity duration-300 FiraCodeFont">
                            {formattedReleaseDate ? <><strong>Date aired:</strong> {formattedReleaseDate}</> : ''}
                        </p>
                        <p id="series-platform" class="text-sm lg:text-md text-white text-start transition-opacity duration-300 FiraCodeFont">
                            {initialplatform ? <><strong>Platform:</strong> {initialplatform}</> : ''}
                        </p>
                        <p id="series-runtime" class="text-sm lg:text-md text-white text-start transition-opacity duration-300 FiraCodeFont">
                            {initialRuntimeFormatted ? <><strong>Total runtime:</strong> {initialRuntimeFormatted.replace('Total runtime: ', '')}</> : ''}
                        </p>
                        <p id="series-genres" class="text-sm lg:text-md text-white text-start transition-opacity duration-300 FiraCodeFont capitalize">
                            {initialgenres ? <><strong>Genres:</strong> {initialgenres}</> : ''}
                        </p>
                        <p id="series-director" class="text-sm lg:text-md text-white text-start transition-opacity duration-300 FiraCodeFont">
                            {initialdirector ? <><strong>Director:</strong> {initialdirector}</> : ''}
                        </p>
                        <p id="series-actors" class="text-sm lg:text-md text-white text-start transition-opacity duration-300 FiraCodeFont">
                            {initialactors ? <><strong>Actors:</strong> {initialactors}</> : ''}
                        </p>
                        <p id="series-country" class="text-sm lg:text-md text-white text-start transition-opacity duration-300 FiraCodeFont">
                            {initialcountry ? <><strong>Country:</strong> {initialcountry}</> : ''}
                        </p>
                    </div>
                </div>

                <div class="mt-auto pb-8">
                    <CarruselCardsTrakt series={series} />
                </div>
                
            </div>
        </div>
    </main>
</Layout>

<style>
    /* Altura del contenido restando el nav de 53px */
    .main-height {
        min-height: calc(100dvh - 53px);
    }

    /* Transición suave para el fondo */
    #main-bg {
        transition: background-image 0.5s ease-in-out, opacity 0.5s ease-in-out;
        background-position: center;
        background-size: cover;
    }

    /* Clase para fade out */
    #main-bg.fade-out {
        opacity: 0.7;
    }

    /* Transición para el título y metadatos */
    #series-title,
    #series-release-date,
    #series-season,
    #series-platform,
    #series-runtime,
    #series-genres,
    #series-actors,
    #series-director,
    #series-country {
        transition: opacity 0.3s ease-in-out;
    }

    #series-title.fade-out,
    #series-release-date.fade-out,
    #series-season.fade-out,
    #series-platform.fade-out,
    #series-runtime.fade-out,
    #series-genres.fade-out,
    #series-actors.fade-out,
    #series-director.fade-out,
    #series-country.fade-out {
        opacity: 0;
    }
</style>

<script is:inline>
(function() {
    function initFullView() {
        const mainBg = document.getElementById('main-bg');
        const seriesTitle = document.getElementById('series-title');
        const seriesReleaseDate = document.getElementById('series-release-date');
        const seriesSeason = document.getElementById('series-season');
        const seriesPlatform = document.getElementById('series-platform');
        const seriesRuntime = document.getElementById('series-runtime');
        const seriesGenres = document.getElementById('series-genres');
        const seriesActors = document.getElementById('series-actors');
        const seriesDirector = document.getElementById('series-director');
        const seriesCountry = document.getElementById('series-country');
        
        // Array de todos los elementos de metadata para facilitar operaciones
        const metadataElements = [
            seriesTitle, seriesReleaseDate, seriesSeason, seriesPlatform,
            seriesRuntime, seriesGenres, seriesActors,
            seriesDirector, seriesCountry
        ].filter(el => el !== null);
        
        if (!mainBg || !seriesTitle) return;

        // Formatear fecha a mes completo y año en inglés
        function formatReleaseDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            } catch (e) {
                return '';
            }
        }

        // Convertir código de país a nombre completo
        function getCountryName(countryCode) {
            if (!countryCode) return '';
            try {
                const regionNames = new Intl.DisplayNames(['en'], { type: 'region' });
                return regionNames.of(countryCode.toUpperCase());
            } catch (e) {
                return countryCode;
            }
        }

        // Formatear minutos a horas y minutos
        function formatMinutesToHours(totalMinutes) {
            if (!totalMinutes) return '';
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            if (hours > 0 && minutes > 0) return `${hours}h ${minutes}m`;
            if (hours > 0) return `${hours}h`;
            return `${minutes}m`;
        }

        // Formatear runtime completo: "Total runtime: 5h 12m (13 episodes 24m/ep)"
        function formatRuntimeComplete(runtime, episodeCount) {
            if (!runtime || !episodeCount) return '';
            const totalMinutes = parseInt(runtime) * parseInt(episodeCount);
            return `Total runtime: ${formatMinutesToHours(totalMinutes)} (${episodeCount} episodes ${runtime}m/ep)`;
        }

        // Manejar cambio de card activa
        function handleCarruselChange(event) {
            const { fanart, title, season, releaseDate, platform, runtime, episodeCount, genres, actors, director, country } = event.detail;
            
            // Fade out de todos los elementos
            metadataElements.forEach(el => el.classList.add('fade-out'));
            
            // Fade out del fondo
            mainBg.classList.add('fade-out');
            
            // Después de la transición, cambiar contenido
            setTimeout(() => {
                // Actualizar fondo
                if (fanart) {
                    mainBg.style.backgroundImage = `url('${fanart}')`;
                }
                
                // Actualizar título
                seriesTitle.textContent = title || '';
                
                // Actualizar fecha
                if (seriesReleaseDate) {
                    const formattedDate = formatReleaseDate(releaseDate);
                    seriesReleaseDate.innerHTML = formattedDate ? `<strong>Date aired:</strong> ${formattedDate}` : '';
                }
                
                // Actualizar temporada
                if (seriesSeason) {
                    seriesSeason.innerHTML = season ? `<strong>Season</strong> ${season}` : '';
                }
                
                // Actualizar plataforma
                if (seriesPlatform) {
                    seriesPlatform.innerHTML = platform ? `<strong>Platform:</strong> ${platform}` : '';
                }
                
                // Actualizar runtime
                if (seriesRuntime) {
                    const runtimeText = formatRuntimeComplete(runtime, episodeCount);
                    seriesRuntime.innerHTML = runtimeText ? `<strong>Total runtime:</strong> ${runtimeText.replace('Total runtime: ', '')}` : '';
                }
                
                // Actualizar géneros
                if (seriesGenres) {
                    seriesGenres.innerHTML = genres ? `<strong>Genres:</strong> ${genres}` : '';
                }
                
                // Actualizar actores
                if (seriesActors) {
                    seriesActors.innerHTML = actors ? `<strong>Actors:</strong> ${actors}` : '';
                }
                
                // Actualizar director
                if (seriesDirector) {
                    seriesDirector.innerHTML = director ? `<strong>Director:</strong> ${director}` : '';
                }
                
                // Actualizar país
                if (seriesCountry) {
                    const countryName = getCountryName(country);
                    seriesCountry.innerHTML = countryName ? `<strong>Country:</strong> ${countryName}` : '';
                }
                
                // Fade in de todos los elementos
                mainBg.classList.remove('fade-out');
                metadataElements.forEach(el => el.classList.remove('fade-out'));
            }, 300);
        }

        // Manejar inicialización del carrusel
        function handleCarruselInit(event) {
            const { fanart, title, season } = event.detail;
            
            // Setear valores iniciales sin animación
            if (fanart) {
                mainBg.style.backgroundImage = `url('${fanart}')`;
            }
            
            seriesTitle.textContent = title || '';
        }

        // Escuchar eventos del carrusel
        document.addEventListener('carrusel:change', handleCarruselChange);
        document.addEventListener('carrusel:init', handleCarruselInit);
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initFullView);
    } else {
        initFullView();
    }
    document.addEventListener('astro:after-swap', initFullView);
})();
</script>
